<?xml version="1.0" standalone="yes"?>

<!-- Generated by BEAUTi v1.10.5 Prerelease #23570d1                         -->
<!--       by Alexei J. Drummond, Andrew Rambaut and Marc A. Suchard         -->
<!--       Department of Computer Science, University of Auckland and        -->
<!--       Institute of Evolutionary Biology, University of Edinburgh        -->
<!--       David Geffen School of Medicine, University of California, Los Angeles-->
<!--       http://beast.community/                                           -->
<beast version="1.10.5">


	<!-- The list of taxa to be analysed (can also include dates/ages).          -->
	<!-- ntax=1610                                                               -->
	<taxa id="taxa">
		TAXA LIST
	</taxa>

    <newick id="startingTree" usingHeights="true" usingDates="false">
		STARTING TREE (newick format)
	</newick>

	<!-- Generate a tree model                                                   -->
	<treeModel id="treeModel">
		<newick idref="startingTree"/>
		<rootHeight>
			<parameter id="treeModel.rootHeight"/>
		</rootHeight>
		<nodeHeights internalNodes="true">
			<parameter id="treeModel.internalNodeHeights"/>
		</nodeHeights>
		<nodeHeights internalNodes="true" rootNode="true">
			<parameter id="treeModel.allInternalNodeHeights"/>
		</nodeHeights>
	</treeModel>


    <compoundParameter id="birthRate.increments">
        <parameter id="birthRateAtPresent" value="-2.0"/>
        <parameter id="birthRateDelta" dimension="DIM" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.birthRate" dim="DIM" incrementTransformType="log">
        <compoundParameter idref="birthRate.increments"/>
    </transformedVectorSumTransform>

    <compoundParameter id="deathRate.increments">
        <parameter id="deathRateAtPresent" value="-2.0"/>
        <parameter id="deathRateDelta" dimension="DIM" value="0"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.deathRate" dim="DIM" incrementTransformType="log">
        <compoundParameter idref="deathRate.increments"/>
    </transformedVectorSumTransform>

    <compoundParameter id="samplingRate.increments">
        <parameter id="samplingRateAtPresent" value="-2.0"/>
        <parameter id="samplingRateDelta" dimension="DIM" value="0.01"/>
    </compoundParameter>

    <transformedVectorSumTransform id="bdss.samplingRate" dim="DIM" incrementTransformType="log">
        <compoundParameter idref="samplingRate.increments"/>
    </transformedVectorSumTransform>

    <newBirthDeathSerialSampling id="bdss" units="years" hasFinalSample="false" conditionOnSurvival="false">
        <birthRate>
            <parameter idref="bdss.birthRate"/>
        </birthRate>
        <deathRate gradientFlag = "false">
            <parameter idref="bdss.deathRate"/>
        </deathRate>
        <samplingRate>
            <parameter idref="bdss.samplingRate"/>
        </samplingRate>
        <samplingProbability gradientFlag = "false">
            <compoundParameter id="bdss.samplingProbability">
                <parameter id="samplingAtPresent" value="0" dimension="1" lower="0.0" upper="1.0"/>
                <parameter id="otherSampling" value="0" dimension="DIM - 1" lower="0.0" upper="1.0"/>
            </compoundParameter>
        </samplingProbability>
        <treatmentProbability gradientFlag = "false">
            <parameter id="bdss.treatmentProbability" value="1.0" dimension="DIM" lower="0.0" upper="1.0"/>
        </treatmentProbability>
        <origin>
            <parameter id="bdss.origin" value="ORIGIN TIME" lower="0.0"/>
        </origin>
        <cutOff>
            <parameter value="CUT OFF TIME"/>
        </cutOff>
        <numGridPoints>
            <parameter value="DIM"/>
        </numGridPoints>
    </newBirthDeathSerialSampling>



    <speciationLikelihood id="speciation" useNewLoop="true">
        <model>
            <birthDeathSerialSampling idref="bdss"/>
        </model>
        <speciesTree>
            <treeModel idref="treeModel"/>
        </speciesTree>
    </speciationLikelihood>



    <distributionLikelihood id="birthRateAtPresentPrior">
        <data>
            <parameter idref="birthRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="birthRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="MEAN"/>
                </mean>
                <stdev>
                    <parameter value="SD" lower="0.0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>

    <distributionLikelihood id="deathRateAtPresentPrior">
        <data>
            <parameter idref="deathRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="deathRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="MEAN"/>
                </mean>
                <stdev>
                    <parameter value="SD" lower="0.0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>

    <distributionLikelihood id="samplingRateAtPresentPrior">
        <data>
            <parameter idref="samplingRateAtPresent"/>
        </data>
        <distribution>
            <normalDistributionModel id="samplingRateAtPresentPriorDistribution">
                <mean>
                    <parameter value="MEAN"/>
                </mean>
                <stdev>
                    <parameter value="SD" lower="0.0"/>
                </stdev>
            </normalDistributionModel>
        </distribution>
    </distributionLikelihood>


    <bayesianBridge id="birthRateDeltaPrior">
        <parameter idref="birthRateDelta"/>
        <globalScale>
            <parameter id="birthRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="birthRateDeltaPrior.localScale" value="0.1" dimension="DIM-1"/> <!-- keep these fixed for Normal -->
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
			<parameter value="2.0"/>
		</slabWidth>
    </bayesianBridge>

	<bayesianBridge id="deathRateDeltaPrior">
        <parameter idref="deathRateDelta"/>
        <globalScale>
            <parameter id="deathRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="deathRateDeltaPrior.localScale" value="0.1" dimension="DIM-1"/>
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
			<parameter value="2.0"/>
		</slabWidth>
    </bayesianBridge>


    <bayesianBridge id="samplingRateDeltaPrior">
        <parameter idref="samplingRateDelta"/>
        <globalScale>
            <parameter id="samplingRateDeltaPrior.globalScale" value="0.1" lower="0.0"/>
        </globalScale>
        <localScale>
            <parameter id="samplingRateDeltaPrior.localScale" value="0.1" dimension="DIM-1"/>
        </localScale>
        <exponent>
            <parameter value="0.25"/>
        </exponent>
        <slabWidth>
			<parameter value="2.0"/>
		</slabWidth>
    </bayesianBridge>



    <gammaPrior id="birthRateDeltaGlobalScalePrior" shape="1" scale="1">
        <parameter idref="birthRateDeltaPrior.globalScale"/>
    </gammaPrior>

    <gammaPrior id="deathRateDeltaGlobalScalePrior" shape="1" scale="1">
        <parameter idref="deathRateDeltaPrior.globalScale"/>
    </gammaPrior>

    <gammaPrior id="samplingRateDeltaGlobalScalePrior" shape="1" scale="1">
        <parameter idref="samplingRateDeltaPrior.globalScale"/>
    </gammaPrior>



    <compoundGradient id="grad.bdss.prior">
        <gradient>
            <multivariateDistributionLikelihood idref="birthRateAtPresentPrior"/>
            <parameter idref="birthRateAtPresent"/>
        </gradient>
        <bayesianBridge idref="birthRateDeltaPrior"/>
		<gradient>
            <multivariateDistributionLikelihood idref="deathRateAtPresentPrior"/>
            <parameter idref="deathRateAtPresent"/>
        </gradient>
        <bayesianBridge idref="deathRateDeltaPrior"/>
        <gradient>
            <multivariateDistributionLikelihood idref="samplingRateAtPresentPrior"/>
            <parameter idref="samplingRateAtPresent"/>
        </gradient>
        <bayesianBridge idref="samplingRateDeltaPrior"/>
    </compoundGradient>

    <compoundGradient id="grad.bdssIncrements.likelihood">
        <gradientWrtIncrements1D id="grad.birthRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="birthRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="birthRate.increments"/>
        </gradientWrtIncrements1D>
		<gradientWrtIncrements1D id="grad.deathRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="deathRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="deathRate.increments"/>
        </gradientWrtIncrements1D>
        <gradientWrtIncrements1D id="grad.samplingRateIncrements" incrementTransformType="log">
            <speciationLikelihoodGradient wrtParameter="samplingRate" useNewLoop="true">
                <speciationLikelihood idref="speciation"/>
                <treeModel idref="treeModel"/>
            </speciationLikelihoodGradient>
            <compoundParameter idref="samplingRate.increments"/>
        </gradientWrtIncrements1D>
    </compoundGradient>

   <birthDeathCompoundParameterLogger id="effectiveReproductiveNumber" compoundParameterType = "effectiveReproductiveNumber">
	   <newBirthDeathSerialSampling idref="bdss"/>
   </birthDeathCompoundParameterLogger>




	<!-- Define operators                                                        -->
	<operators id="operators" optimizationSchedule="power">
		<hamiltonianMonteCarloOperator weight="1" nSteps="15" stepSize="0.01" mode="vanilla"
									   drawVariance="1.0" autoOptimize="true" targetAcceptanceProbability="0.7"
									   preconditioningUpdateFrequency="3" preconditioningDelay="0">
			<jointGradient>
				<compoundGradient idref="grad.bdssIncrements.likelihood"/>
				<compoundGradient idref="grad.bdss.prior"/>
			</jointGradient>
			<preconditioner>
				<compoundPriorPreconditioner id="priorPreconditioner">
					<normalDistributionModel idref="birthRateAtPresentPriorDistribution"/>
					<bayesianBridgeDistribution idref="birthRateDeltaPrior"/>
					<normalDistributionModel idref="deathRateAtPresentPriorDistribution"/>
					<bayesianBridgeDistribution idref="deathRateDeltaPrior"/>
					<normalDistributionModel idref="samplingRateAtPresentPriorDistribution"/>
					<bayesianBridgeDistribution idref="samplingRateDeltaPrior"/>
				</compoundPriorPreconditioner>
			</preconditioner>
		</hamiltonianMonteCarloOperator>

        <!-- <randomWalkOperator windowSize="1.0" weight="1.0">
    		<parameter idref="deathRateAtPresent"/>
		</randomWalkOperator> -->
		<randomWalkOperator windowSize="1.0" weight="1.0">
   			 <parameter idref="bdss.origin"/>
		</randomWalkOperator>


                      <!-- <adaptableVarianceMultivariateNormalOperator scaleFactor="0.01" weight="10" initial="1000" burnin="500" beta="0.05" coefficient="1.0" autoOptimize="true" formXtXInverse="false">
                        <transform type="none">
                            <parameter idref="birthRate.increments"/>
                            <parameter idref="deathRate.increments"/>
                            &lt;!&ndash; <parameter idref="samplingRate.increments"/> &ndash;&gt;
                            <parameter idref="samplingRateAtPresent"/>
                        </transform>
                    </adaptableVarianceMultivariateNormalOperator> -->

		<!-- Move the bridge -->
		<bayesianBridgeGibbsOperator weight="1">
			<bayesianBridge idref="birthRateDeltaPrior"/>
			<gammaPrior idref="birthRateDeltaGlobalScalePrior"/>
		</bayesianBridgeGibbsOperator>
		<bayesianBridgeGibbsOperator weight="1">
			<bayesianBridge idref="deathRateDeltaPrior"/>
			<gammaPrior idref="deathRateDeltaGlobalScalePrior"/>
		</bayesianBridgeGibbsOperator>
		<bayesianBridgeGibbsOperator weight="1">
			<bayesianBridge idref="samplingRateDeltaPrior"/>
			<gammaPrior idref="samplingRateDeltaGlobalScalePrior"/>
		</bayesianBridgeGibbsOperator>
	</operators>


	<!-- Define MCMC                                                             -->
	<mcmc id="mcmc" chainLength="30000000" autoOptimize="true" fullEvaluation="0" operatorAnalysis="OPSNAME">
		<joint id="joint">
			<prior id="prior">
				<distributionLikelihood idref="birthRateAtPresentPrior"/>
				<bayesianBridge idref="birthRateDeltaPrior"/>
				<gammaPrior idref="birthRateDeltaGlobalScalePrior"/>
				<distributionLikelihood idref="deathRateAtPresentPrior"/>
				<bayesianBridge idref="deathRateDeltaPrior"/>
				<gammaPrior idref="deathRateDeltaGlobalScalePrior"/>
				<distributionLikelihood idref="samplingRateAtPresentPrior"/>
				<bayesianBridge idref="samplingRateDeltaPrior"/>
				<gammaPrior idref="samplingRateDeltaGlobalScalePrior"/>
				<!-- <distributionLikelihood idref="deathRateAtPresentPrior"/> -->
				<truncated lower="0.0">
					<normalPrior mean="1.89" stdev="0.5">
						<parameter idref="bdss.origin"/>
					</normalPrior>
				</truncated>
			</prior>
			<likelihood id="likelihood">
				<speciationLikelihood idref="speciation"/>
			</likelihood>
		</joint>
		<operators idref="operators"/>

		<!-- write log to screen                                                     -->
		<log id="screenLog" logEvery="1000">
			<column label="Joint" dp="4" width="12">
				<joint idref="joint"/>
			</column>
			<column label="Prior" dp="4" width="12">
				<prior idref="prior"/>
			</column>
			<column label="Likelihood" dp="4" width="12">
				<likelihood idref="likelihood"/>
			</column>
			<column label="rootHeight" sf="6" width="12">
				<parameter idref="treeModel.rootHeight"/>
			</column>
		</log>

		<!-- write log to file                                                       -->
		<log id="fileLog1" logEvery="1000" fileName="bs_all_para_pre_NSTEPS_1.log" overwrite="false">
			<joint idref="joint"/>
			<prior idref="prior"/>
			<likelihood idref="likelihood"/>
			<parameter idref="bdss.birthRate"/>
			<parameter idref="bdss.deathRate"/>
			<parameter idref="bdss.samplingRate"/>
			<parameter idref="birthRate.increments"/>
			<parameter idref="deathRate.increments"/>
            <parameter idref="samplingRate.increments"/>
			<parameter idref="birthRateDeltaPrior.globalScale"/>
			<parameter idref="birthRateDeltaPrior.localScale"/>
			<parameter idref="deathRateDeltaPrior.globalScale"/>
			<parameter idref="deathRateDeltaPrior.localScale"/>
			<parameter idref="samplingRateDeltaPrior.globalScale"/>
			<parameter idref="samplingRateDeltaPrior.localScale"/>
			<parameter idref="bdss.origin"/>
           <birthDeathCompoundParameterLogger idref="effectiveReproductiveNumber"/>
			<speciationLikelihood idref="speciation"/>
		</log>

	</mcmc>

	<report>
		<property name="timer">
			<mcmc idref="mcmc"/>
		</property>
	</report>


</beast>

